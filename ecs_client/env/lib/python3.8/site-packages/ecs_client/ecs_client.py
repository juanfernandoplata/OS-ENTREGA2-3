import socket
from struct import Struct

client_server = None

CLIENTS_SERVER_IP = "127.0.0.1"
CLIENTS_SERVER_PORT = 8000

out_format = Struct( "i120s120s" )
in_format = Struct( "i240s" )

def print_bytes( bytes ):
    string = ""
    i = 0
    while( bytes[ i ] != 0 ):
        string += chr( bytes[ i ] )
        i += 1
    print( string, end = "" )

class ecs_client:

    def __init__( this ):
        this.server = None
        this.connected = False
    
    def connect( this ):
        try:
            this.server = socket.socket( socket.AF_INET, socket.SOCK_STREAM )
            try:
                this.server.connect( ( CLIENTS_SERVER_IP, CLIENTS_SERVER_PORT ) )
                this.connected = True
            except socket.error as error:
                print( "Could not connect to server..." )
                print( "Error: %s" % error )
        except socket.error as error:
            this.server = None
            print( "Could not create socket..." )
            print( "Error: %s" % error )
    
    def create_instance( this, name, image ):
        if( this.connected ):
            data = out_format.pack( 3, name.encode(), image.encode() )
            try:
                this.server.sendall( data )
            except socket.error as error:
                raise Exception( "Data was not sent correctly..." )
            try:
                data = in_format.unpack( this.server.recv( in_format.size ) )
                print_bytes( data[ 1 ] )
            except socket.error as error:
                raise Exception( "Data was not recieved correctly..." )
        else:
            raise Exception( "Requested action can not be proccesed. Connection has not been established with the server yet..." )

    def stop_instance( this, name ):
        if( this.connected ):
            data = out_format.pack( 4, name.encode(), "".encode() )
            try:
                this.server.sendall( data )
            except socket.error as error:
                raise Exception( "Data was not sent correctly..." )
            try:
                data = in_format.unpack( this.server.recv( in_format.size ) )
                print_bytes( data[ 1 ] )
            except socket.error as error:
                raise Exception( "Data was not recieved correctly..." )
        else:
            raise Exception( "Requested action can not be proccesed. Connection has not been established with the server yet..." )

    def erase_instance( this, name ):
        if( this.connected ):
            data = out_format.pack( 5, name.encode(), "".encode() )
            try:
                this.server.sendall( data )
            except socket.error as error:
                raise Exception( "Data was not sent correctly..." )
            try:
                data = in_format.unpack( this.server.recv( in_format.size ) )
                print_bytes( data[ 1 ] )
            except socket.error as error:
                raise Exception( "Data was not recieved correctly..." )
        else:
            raise Exception( "Requested action can not be proccesed. Connection has not been established with the server yet..." )

    def list_instances( this ):
        if( this.connected ):
            data = out_format.pack( 6, "".encode(), "".encode() )
            try:
                this.server.sendall( data )
            except socket.error as error:
                raise Exception( "Data was not sent correctly..." )
            try:
                data = in_format.unpack( this.server.recv( in_format.size ) )
                print_bytes( data[ 1 ] )
            except socket.error as error:
                raise Exception( "Data was not recieved correctly..." )

        else:
            raise Exception( "Requested action can not be proccesed. Connection has not been established with the server yet..." )

    def disconnect( this ):
        this.server = None
        this.connected = False
